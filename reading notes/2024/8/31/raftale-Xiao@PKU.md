# 交易是如何写入区块链中的

> 39分开始

这节的主要问题是：谁来决定哪些交易按照什么顺序被写入区块链中？



## 分布式共识

区块链是一个分布式的账本，账本的内容要取得分布式的共识。

> distributed consensus

分布式共识的一个简单例子就是分布式哈希表。



分布式系统中有很多不可能结论（Impossibility result）：

1. FLP impossibility result：在一个异步(asynchronous)系统里，即使只有一个成员有问题(faulty)，也不可能取得共识。

2. CAP theorem：Consitency, Availability, Partition tolerance. 三者只能取其二。

    1. > 按照DDIA中的说法，P是必然存在的，出现P时只能选择CP或者AP

3. Paxos：能够保证Consitency，但是某些情况下有可能小概率的一直没有办法达成共识。

## 比特币共识

如何设计比特币的共识协议，来防止系统中存在恶意的节点攻击。

简单的设计思路：直接投票。

直接投票的问题有：

1. 节点投票非法的候选区块
2. 节点不投票：行政不作为
3. 效率问题：网络延迟，每轮投票等多久

但更大的问题是：任何基于投票的方案都要确定谁有投票权（membership）。

联盟链中基于投票的方案是可行的，因为不存在恶意的节点。

直接投票在公链中的缺点是：由于比特币中账户的生成是可以无限的，恶意的节点可以产生无限的账户，当产生账户超过总数的一半，投票本身就是恶意攻击，这也被称为女巫攻击（Sybil attack）。



比特币中利用了一个很巧妙的机制来解决这个问题，基于计算力投票（工作量证明）而不是账户数目投票来防止女巫攻击。每个节点都可以在本地构造一个候选区块，把他认为合法的交易放到区块中，然后尝试各种`nonce`值，只要满足`H(block header) <= target` ，就获得了记账权，也就是获得了向比特币区块链中中写入下一个区块的权利，其他节点收到这个区块之后验证区块内容的合法性。



## Longest Valid Chain

另一个问题来了，通过合法性验证的区块就一定会被接受吗？

看下面这个例子：

```
                                              
 ┌──────┐◄──┬──────┐◄───┬──────┐◄───┬──────┐ 
 │C->A  │   │      │◄-┐ │ A->B │    │      │ 
 └──────┘   └──────┘  │ └──────┘    └──────┘ 
                      │                       
                      └──┬──────┐             
                         │A->A' │             
                         └──────┘             
```

A 转B 之后，A又转给它自己，相当于把A->B给回滚了。

内容合法的区块不一定在最长合法链上（Longest Valid Chain），这种也被称为forking attack。

比特币协议中规定：接受的区块应该是在最长合法链上。

临时性的分叉的非最长链被称为orphan block，会被丢弃掉。

```
                                                                        
                                                  ┌───────┐◄──┬───────┐ 
                                              ┌───┤       │   │       │ 
 ┌──────┐◄──┬──────┐ ◄───┬──────┐◄───┬──────┐ │   └───────┘   └───────┘ 
 │C->A  │   │      │ ◄┐  │ A->B │    │      │◄┘                         
 └──────┘   └──────┘  │  └──────┘    └──────┘◄┐   ┌───────┐             
                      │                       └───┼       │             
                      │                           └───────┘             
                      └──┬──────┐                 orphan block          
                         │A->A' │                                       
                         └──────┘                                       
```



为什么节点要去争夺记账权呢？

获得记账权的节点可以获得铸币的奖励（block reward），coinbase transaction是比特币中发行新的比特币的唯一方法，coinbase transaction不用指定币的来源。

最开始每一个发布的区块可以产生50BTC，每过21万个区块（大概4年） 出块就需要减半。



> 1小时21分

课后问题：

- 比特币的共识机制要取得的共识是什么？只有获得记账权的节点才能写入区块。
- 如何防范女巫攻击？
    - 每秒钟能够试多少个nonce的数目，称为hash rate，hash rate决定了出块的概率。
    - 争夺记账权的过程：mining
    - 争夺记账权的节点被称为矿工miner
