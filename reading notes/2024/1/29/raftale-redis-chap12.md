epoll: https://www.bilibili.com/video/BV1r54y1f7bU

博客：https://pdai.tech/md/db/nosql-redis/db-redis-x-event.html

Redis服务器是一个事件驱动系统，服务器需要处理以下两类事件：

1. 文件事件：对socket操作的抽象，就是网络IO
2. 时间事件：内部操作如定时器执行

# 文件事件

Redis使用Reactor模式开发了自己的网络事件处理器：文件事件处理器

1. 文件事件处理器使用I/O多路复用来同时监听多个socket，并根据socket目前执行的任务来为socket关联不同的事件处理器
2. 当被监听的socket准备好执行accept, read, write, close等操作时，就会产生一个文件事件，这时文件事件处理器就会调用socket之前关联好的事件处理器来处理这些事件。

虽然文件事件处理器以单线程方式运行，但通过使用I/O多路复用程序来监听多个socket，即实现了高性能的网络通信模块，又很好地与redis服务器中其他以单线程方式运行的模块进行对接，保持了内部单线程设计的简单性。



## 文件事件处理器的构成


1. socket
2. I/O多路复用程序
3. 文件事件分派器（dispatcher）
4. 事件处理器

虽然多个文件事件可能会并发地出现，但IO多路复用程序会将所有socket都放到一个队列中，然后通过这个队列，以有序、同步、单个的传送socket事件。

I/O多路复用程序的所有功能都是通过包装常见的select，epoll, evport和kqueue这些函数库来实现的。




为什么单线程的Redis性能高？

Redis的瓶颈主要在IO而不是CPU，6.0版本之前是单线程模型。单线程是指 Redis的网络IO和键值对读写是由一个线程来完成的。



# 时间事件

事件事件分为以下两类：

1. 定时事件
2. 周期性事件

一个时间事件由以下三个属性组成：

1. id：全局递增ID
2. when：事件的到达时间
3. timeProc：时间事件处理器



实现：

服务器将所有时间事件放到一个无序链表中，每当时间事件执行器运行时，它就遍历整个链表，查找所有已到达的时间事件，并调用相应的事件处理器。
