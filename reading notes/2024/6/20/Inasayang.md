# grokking streaming systems real-time event processing pp. 152-167

## ch7.Windowed computations

- standard windowing strategies
- time stamps in events
- windowing watermark and late events

### Slicing up real-time data

实时数据切片是指将实时获取的数据进行分段或分割，以便进行更精细的分析和处理。在检测信用卡欺诈的情况下，我们需要对每个信用卡交易进行分析，找出在短时间内跨越较大地理距离的交易记录。

- 数据收集：获取每笔交易的详细信息，包括交易时间、交易地点、交易金额等。
- 数据切片：将数据按时间顺序排列，并按一定时间间隔进行切片。例如，可以按小时、分钟或秒钟为单位进行切片。
- 计算距离：对每个时间切片内的交易计算其地理位置之间的距离。可以使用地理编码服务将地址转换为经纬度坐标，然后使用Haversine公式计算两点之间的直线距离。
- 识别异常：将计算出的距离与最大可能的旅行距离（例如每小时500英里）进行比较。如果某笔交易的地理距离超过该阈值，则将其标记为潜在的欺诈交易。
- 报警机制：对标记为潜在欺诈的交易生成警报，并进一步调查这些交易的真实性。
- 商户监控：不仅要监控单张信用卡的异常使用，还要监控特定商户的异常交易模式。例如，如果同一加油站在短时间内出现多张不同信用卡的高频次交易，则可能表明该商户正遭受攻击。

防止欺诈的两种方法：单卡分析与商户分析

- 单卡分析
  - 定义窗口：将时间划分为固定长度的窗口，例如1小时、2小时等。每个窗口内的交易会被单独分析。
  - 计算距离：在每个窗口内，计算每次交易之间的地理距离。如果在短时间内交易地点的距离超过合理范围（例如每小时500英里），则标记为可疑交易。
  - 识别异常交易：
    - 规则1：如果在一个窗口内的交易距离超过合理范围，则标记该交易为可疑。
    - 规则2：如果在连续的窗口中多次出现距离异常，则进一步确认该信用卡为高风险卡，可能被盗用。

- 商户分析
  - 商户监控：监控特定商户的所有交易。
  - 多卡分析：在特定时间窗口内，分析同一商户的多张信用卡交易。
  - 识别商户攻击：
    - 规则1：如果在短时间内，多个不同信用卡在同一商户进行高频交易，则标记该商户为可能的攻击目标。
    - 规则2：如果在不同地点的同一连锁商户出现高频交易，也应引起注意。

### What exactly are windows?

![01](https://inasa.dev/img/grokkingstreamingsystems/ch7/01.png)

在流处理系统中使用窗口可以让开发人员将无尽的事件流切割成块进行处理。需要注意的是，这种切割大多数情况下可以是基于时间（时间窗口）或基于事件计数的。

基于每个事件或个体的流处理系统在许多情况下效果很好，但随着问题的复杂性增加，它可能会有一些局限性。

![02](https://inasa.dev/img/grokkingstreamingsystems/ch7/02.png)

### New concept: Windowing strategy

三种窗口化策略是：

- Fixed window
- Sliding window
- Session window

#### Fixed windows

固定窗口也被称为滚动窗口。从每个窗口的开始到结束接收的事件被分组为一个批次一起处理。例如，当配置一个固定的一分钟时间窗口（也称为分钟窗口）时，同一个一分钟窗口内的所有事件将被分组在一起处理。固定窗口简单直接，在许多场景中非常有用。

两种类型的Fixed window：

- Time windows：由一个不变的时间间隔定义
- Count windows：由一个不变的事件处理数量间隔定义
