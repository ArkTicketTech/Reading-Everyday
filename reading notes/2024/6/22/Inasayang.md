# grokking streaming systems real-time event processing pp. 167-184

## ch7.Windowed computations

- standard windowing strategies
- time stamps in events
- windowing watermark and late events

### Slicing up real-time data

实时数据切片是指将实时获取的数据进行分段或分割，以便进行更精细的分析和处理。在检测信用卡欺诈的情况下，我们需要对每个信用卡交易进行分析，找出在短时间内跨越较大地理距离的交易记录。

- 数据收集：获取每笔交易的详细信息，包括交易时间、交易地点、交易金额等。
- 数据切片：将数据按时间顺序排列，并按一定时间间隔进行切片。例如，可以按小时、分钟或秒钟为单位进行切片。
- 计算距离：对每个时间切片内的交易计算其地理位置之间的距离。可以使用地理编码服务将地址转换为经纬度坐标，然后使用Haversine公式计算两点之间的直线距离。
- 识别异常：将计算出的距离与最大可能的旅行距离（例如每小时500英里）进行比较。如果某笔交易的地理距离超过该阈值，则将其标记为潜在的欺诈交易。
- 报警机制：对标记为潜在欺诈的交易生成警报，并进一步调查这些交易的真实性。
- 商户监控：不仅要监控单张信用卡的异常使用，还要监控特定商户的异常交易模式。例如，如果同一加油站在短时间内出现多张不同信用卡的高频次交易，则可能表明该商户正遭受攻击。

防止欺诈的两种方法：单卡分析与商户分析

- 单卡分析
  - 定义窗口：将时间划分为固定长度的窗口，例如1小时、2小时等。每个窗口内的交易会被单独分析。
  - 计算距离：在每个窗口内，计算每次交易之间的地理距离。如果在短时间内交易地点的距离超过合理范围（例如每小时500英里），则标记为可疑交易。
  - 识别异常交易：
    - 规则1：如果在一个窗口内的交易距离超过合理范围，则标记该交易为可疑。
    - 规则2：如果在连续的窗口中多次出现距离异常，则进一步确认该信用卡为高风险卡，可能被盗用。

- 商户分析
  - 商户监控：监控特定商户的所有交易。
  - 多卡分析：在特定时间窗口内，分析同一商户的多张信用卡交易。
  - 识别商户攻击：
    - 规则1：如果在短时间内，多个不同信用卡在同一商户进行高频交易，则标记该商户为可能的攻击目标。
    - 规则2：如果在不同地点的同一连锁商户出现高频交易，也应引起注意。

### What exactly are windows?

![01](https://inasa.dev/img/grokkingstreamingsystems/ch7/01.png)

在流处理系统中使用窗口可以让开发人员将无尽的事件流切割成块进行处理。需要注意的是，这种切割大多数情况下可以是基于时间（时间窗口）或基于事件计数的。

基于每个事件或个体的流处理系统在许多情况下效果很好，但随着问题的复杂性增加，它可能会有一些局限性。

![02](https://inasa.dev/img/grokkingstreamingsystems/ch7/02.png)

### New concept: Windowing strategy

三种窗口化策略是：

- Fixed window
- Sliding window
- Session window

#### Fixed windows

固定窗口也被称为滚动窗口。从每个窗口的开始到结束接收的事件被分组为一个批次一起处理。例如，当配置一个固定的一分钟时间窗口（也称为分钟窗口）时，同一个一分钟窗口内的所有事件将被分组在一起处理。固定窗口简单直接，在许多场景中非常有用。

两种类型的Fixed window：

- Time windows：由一个不变的时间间隔定义
- Count windows：由一个不变的事件处理数量间隔定义

### Sliding windows

![03](https://inasa.dev/img/grokkingstreamingsystems/ch7/03.png)

### Session windows

会话表示由定义的不活动间隔分隔的活动期，可以用来对事件进行分组。通常，会话窗口是针对特定键的，而不像固定窗口和滑动窗口那样是针对所有事件的全局窗口。

会话窗口通常定义一个超时时间，这是会话保持开放的最长时间。我们可以想象每个键都有一个计时器。如果在计时器超时之前没有收到该键下的事件，会话窗口将被关闭。下次，当收到该键下的事件时，将启动一个新会话。

![04](https://inasa.dev/img/grokkingstreamingsystems/ch7/04.png)

### Windowing: Concept or implementation

- 数据存储和检索：将每张卡的交易存储在一个数据结构中，例如哈希表或数据库，每次有新交易时，将其与过去25小时内的交易进行比较
- 时间窗口管理：每次有新交易进入时，清除所有超过25小时的旧交易，以确保只保留有效交易
- 高效查找：通过对每张卡的交易记录进行时间排序，确保能够快速找到最近的交易

### Windowing watermark

每个事件到达车辆计数操作符实例的时间（处理时间）稍晚于它在物联网传感器中创建的时间（事件时间）。如果窗口在窗口结束时立即关闭，发生在窗口结束附近的事件将会丢失，因为这些事件还没有被计数器实例接收到。它们不能被放入下一个窗口，因为根据事件时间，它们属于已经关闭的窗口。

避免事件丢失的解决方案是将窗口保持开放一段时间，等待事件接收完毕。这段额外的等待时间通常称为窗口水印（windowing watermark）。

- 设置水印：在流处理框架中引入水印（watermark）机制，水印是一个时间标记，用来指示在流中某个时间点之前的所有事件都已经到达。通过设置水印，我们可以在事件时间到达后的一段时间内延迟窗口的关闭，以确保接收到所有可能延迟的事件
- 延迟窗口关闭：通过设置合理的延迟时间，确保大部分事件在窗口关闭之前都能够被处理。例如，可以设置一个几秒钟的延迟，这样即使有些事件晚到了几秒钟，也能被包括在正确的窗口内
- 处理迟到的事件：在极少数情况下，仍然可能有事件在水印之后到达。对于这些迟到的事件，可以将其记录为迟到事件并根据具体需求进行处理，比如丢弃或者重新处理

决定窗口水印等待时间的一些考虑因素：

- 事件延迟分布：分析历史数据，了解事件到达的延迟分布情况。如果大部分事件都能在某个时间范围内到达，可以将这个时间范围作为水印等待时间
- 系统性能：评估系统的处理能力和性能。如果系统能在短时间内处理大量事件，可以设置较短的水印等待时间；否则，应适当延长等待时间，以确保事件完整性
- 业务需求：根据具体业务需求决定等待时间。例如，欺诈检测系统需要尽快处理交易，可以设置较短的水印等待时间；而交通监控系统可能对延迟要求较低，可以设置较长的等待时间
- 测试和调优：在实际环境中进行测试，通过不断调整和优化水印等待时间，找到最佳的平衡点
