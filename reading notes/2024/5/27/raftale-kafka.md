温习下kafka。

生产者发送的时候默认是异步的， 发送阶段包括了等待更多消息加入批次，失败超时重试。
由于生产者发送消息包含了重试，就可能产生重复消息。
为了避免重复消息，可以设置enable.idempotence为true。原理是给每个Producer分配一个PID，每个消息分配一个序列号，broker会将这两个ID记录下来来判定消息是否唯一。即使刚发送消息broker就挂掉又重启，这些ID还是能通过broker同步实现消息去重。
> 生产者幂等性只针对发送消息时产生的重试，其他原因造成的重复消息则不在这考虑之内。

消息的key哈希后用作分区。

消费者
1. 消费者群组 -> 消费者
2. 消费者数量不能超过分区数量
3. 再均衡：新的分区产生，分区会重分配消费者

如何保证消息无丢失？
1. 需要正确的同步、重试配置来满足可靠性
   1. acks > 1 
   2. min.insync.replicas > 1;
   3. unclean.leader.election = false; 不允许不同步的副本成为leader
   4. enable.idempotence为true
2. 需要正确的处理错误：
   1. 不可重试错误要进行记录
3. 保证先消费完消息才提交偏移量
