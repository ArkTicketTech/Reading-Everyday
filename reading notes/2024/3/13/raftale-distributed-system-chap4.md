# 分布式共识简介

起源：航空航天追求高可用高容错的系统。

机构：斯坦福研究院

重要的人：Leisle Lamport

成果：SIFT系统。

影响：分布式共识算法越来越多地出现在生产环境中。

## 什么是分布式共识

共识不等于一致性

共识就是在一个可能出现任意故障的分布式系统中的多个节点对某个值达成共识。

用数学语言来描述就是：一个分布式系统包含N个进程，每个进程都有一个初始值，进程之间相互通信，设计一直共识算法使得尽管出现故障，但进程之间仍然能协商某个**不可撤销**的最终决定值，且每次执行都满足以下三个性质：

1. 终止性(Termination)：所有正确的进程最终都会认同某一个值
2. 协定性（Agreement）：所有正确的进程认同的值都是同一个值
3. 完整性(Integrity/Validity)：如果正确的进程都提议同一个值v，那么任何正确进程的最终决定值一定是v

## 为什么要达成共识


分布式的几个主要难题：网络不可靠、时钟不一致、节点故障。

状态机复制是解决上述难题的一种常规方法，一个状态机从初始状态开始，每个输入都被传入转换函数和输出函数，以生成一个新的状态和输出，在收到新的输入前，状态机的状态保持不变。

多副本下，只要节点数量足够多，系统能通过状态机的输出来判断哪些节点的状态机输出是有差异的。

实现状态机复制常常需要一个多副本日志系统，原理是：如果日志的内容和顺序都相同，多个进程从同一状态开始，并且从相同位置以相同的顺序读取日志内容，那么这些进程将生成相同的输出，并且结束在相同的状态。

共识算法常用来实现多副本日志，**共识算法使得每个副本对日志的值和顺序达成共识，**每个节点都存储相同的日志副本，这样整个系统中的每个节点都能有一致的状态和输出。最终，这些节点看起来就像是一个单独的、高可用的状态机。

在共识的帮助下，分布式系统不仅可以像单一节点一样工作，还可以具备高可用、自动容错和高性能。借助共识算法来实现状态机复制，能够解决分布式系统中的大部分问题，所以共识问题是分布式系统最基本、最重要的问题。

# 异步系统中的共识

分布式系统可以分为：

1. 同步系统
2. 异步系统
3. 部分同步系统

异步系统更接近于现实情况，同步系统是一种特殊的异步系统。

## FLP不可能定理

FLP不可能定理：在一个完全异步的系统中，即使只有一个节点出现了故障，也不存在一个算法使系统达成共识。

简单来说，在一个异步系统中，进程可以在任意时间返回响应，我们无法分辨到底是节点延迟太高还是已经崩溃，基于此我们无法在有限时间内达成共识，这不满足终止性。

FLP不可能定理 并不是说，共识算法在一般情况下是不可能实现的，相反，这种不可能的结果 来自于算法流程中最坏的结果：

1. 一个完全异步的系统

2. 系统发生了故障

3. 不可能有一个具备安全性、活性和容错性的共识算法

    1. 安全性：所有进程都认同同一个值

    1. 活性：分布式系统**最终**会认同某一个值

这意味着可以找到一些方法，绕过FLP不可能定理，找到共识问题工程上的解。

一般有三种方法来绕过FLP不可能定理：

1. 故障屏蔽
2. 使用故障检测器
3. 使用随机性算法
