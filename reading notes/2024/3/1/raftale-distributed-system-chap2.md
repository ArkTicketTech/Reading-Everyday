# 两将军问题

两支由不同的将军领导的军队攻打一座城市，两个将军交流的唯一方法是派遣信使穿过敌方城市控制的山谷。

攻占城市成功的唯一条件是两支军队同时攻打，因此两个将军需要约定进攻时间，但因为通信的不可靠，无法确定对方是否收到消息。

将军A向将军B传递了进攻时间，将军B如果不进行回应，将军A无法确定将军B是否收到；将军B向将军A进行了回应，但将军B不知道将军A是否收到了回应。

所以无论进行了多少轮，都无法达成一致。

tcp三步握手是一个近似的工程解，为了缓解两将军问题，tcp握手增加了超时重试的机制。

https://cloud.tencent.com/developer/article/2196837

# 拜占庭将军问题

拜占庭将军问题与两将军问题类似，但更复杂。

拜占庭将军问题中有多个将军攻占同一城市，该问题的挑战在于将军中可能出现叛徒，他们会故意发送错误的信息来进行误导干扰。

拜占庭将军问题需要确保所有忠实的将军在同一计划中达成一致。

该问题将在第四章中讲到。

# 系统模型

## 网络链路模型

在分布式系统中，网络出错常导致的问题是网络分区，网络分区是指由于网络设备故障，导致网络分裂为多个独立的组。也就是节点仍然正常工作，但它们之间的通信链路已经中断。

网络链路分为：

1. 可靠链路：tcp
2. 公平损失链路
3. 任意链路

## 节点故障类型

节点在回复消息时可能出现故障，从而导致消息永久丢失。

故障类型主要分为三种：

1. 崩溃-停止
2. 崩溃-恢复
3. 拜占庭故障：恶意节点

大多数算法是基于崩溃模型来解决问题的，航天航空系统和去中心化的加密货币是建立在拜占庭容错上的。

## 按时间划分系统模型

基于同步与否，我们可以将系统分为同步系统模型和异步系统模型。

同步：一个消息的响应时间在一个有限且已知的时间范围内；

异步：一个消息的响应时间是无限的。

同步系统总是认为会收到期望的消息，但异步系统才是更接近现实的系统。

但纯异步系统中，分布式系统中的一些问题无法解决，如FLP不可能问题，该定理证明了在异步系统中我们难以找到一个满足要求的共识算法。因此有了第三种模型模型：部分同步系统模型。

部分同步系统模型中，我们假设系统在大多数时间都是同步的，但偶尔会因为故障变为异步系统。

# 消息传递语义

消息可能会丢失，为了解决丢失问题，消息会重复发送。但重复发送可能导致副作用，因此要保证系统的幂等操作。

大多数情况下，我们可以给每个消息一个唯一的标识符，通过这种方式，接受者可以避免执行已经执行过的操作。

按照消息传递和处理次数，有三种消息传递语义：

1. 最多一次：消息可能丢失，但不会重复
2. 至少一次：消息不会丢失，但可能重复
3. 精准一次：不会重复也不会丢失

精准传递一次难以实现，因为要建立可靠的连接，必须要重复传递，所以只能做到精确处理一次消息，然后通过幂等来达到看起来是一次的效果。
