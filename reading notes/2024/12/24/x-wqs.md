# HMAC算法实现中的时序攻击漏洞

在本模块的最后一部分,我想向大家展示一个影响许多MAC算法实现的通用攻击。从这种攻击中我们可以学到很好的教训。让我们来看一个特定的HMAC验证实现。这是来自Keyczar库的Python实现。

## 有漏洞的实现

以下是用于验证HMAC生成的标签的代码。为了便于理解,我对代码进行了简化。基本上,输入包括密钥、消息和标签字节。验证方式是重新计算消息的HMAC,然后将得到的16个字节与给定的签名字节进行比较。

这看起来完全没问题。事实上,很多人都是这样实现的。但问题在于,如果你看比较是如何完成的,比较是按字节进行的。Python解释器内部有一个循环遍历所有16个字节。一旦发现不相等,循环就会终止并表示字符串不相等。这种在发现第一个不相等时就退出的比较器,会导致这个库存在严重的时序攻击漏洞。

## 攻击方式

让我来展示如何进行攻击。假设你是攻击者,你有一个消息m,你想为其获取有效的标签。你的目标是攻击一个存储了HMAC密钥的服务器。该服务器提供了一个接口,接收消息-MAC对,检查MAC是否有效,如果有效就处理消息,如果无效就拒绝。

攻击者可以提交大量的消息-MAC对,看是否能推断出他想要攻击的特定消息的标签。以下是如何利用前面提到的有漏洞的实现进行攻击:

1. 攻击者会提交多个消息-标签查询,其中消息始终相同,但会尝试不同的标签
2. 第一次查询时,提交随机标签和目标消息,测量服务器响应时间
3. 接下来尝试所有可能的第一个字节:
   - 先用0作为第一个字节(其余字节随机)
   - 如果服务器响应时间与步骤1相同,则尝试1
   - 如果仍然响应很快,则尝试2
   - 以此类推,直到发现服务器响应时间变长
4. 响应时间变长意味着第一个字节匹配,拒绝发生在第二个字节
5. 此时攻击者知道了标签的第一个字节,可以用相同方法攻击第二个字节
6. 重复这个过程直到获得完整的正确标签

## 防御方法

### 方法一:恒定时间比较

Keyczar库采用了以下防御方法:

1. 首先检查提交的签名字节长度是否正确
2. 如果长度正确,使用始终花费相同时间的比较器:
   - 使用Python的zip函数创建字节对
   - 对每对字节进行XOR运算
   - 将结果OR到最终结果中
   - 比较器总是运行到结束才返回结果

但这种方法可能会被优化编译器破坏,因为编译器可能会优化循环,在发现不匹配时提前退出。

### 方法二:隐藏比较字符串

另一种防御方法是:

1. 计算消息的正确MAC
2. 对MAC和签名字节分别进行一次额外的哈希
3. 比较哈希结果

这样即使签名字节的第一个字节与MAC匹配,额外的哈希层会使得结果完全不同,攻击者无法进行时序攻击。

## 教训

这个例子说明即使是密码库的专家也会犯这样的错误。看似完全正确的代码可能会完全暴露于时序攻击之下。因此:

1. 不要发明自己的加密算法
2. 不要实现自己的加密算法
3. 使用标准库如OpenSSL
4. Keyczar也是一个不错的选择,可以降低遭受此类攻击的风险
