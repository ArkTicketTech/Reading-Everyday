## 标准构造

推荐使用标准认证加密方案:
- GCM
- CCM 
- EAX

正确的认证加密方式是"先加密后MAC":
- 任意加密和MAC算法组合都可提供认证加密
- 前提是加密和MAC算法本身实现正确

## TLS记录协议中的CBC加密攻击

### TLS解密流程

1. CBC解密
2. 检查填充格式(如长度为5应为55555)
3. 验证MAC
4. 若通过则输出数据

### 填充预言机攻击

攻击者可通过两种方式区分填充错误和MAC错误:

1. 错误消息类型(旧版TLS)
2. 时间差异:
   - 填充错误:快速返回(~21ms)
   - MAC错误:需额外验证(~23ms)

### 利用填充预言机解密

攻击步骤:
1. 修改密文块C0最后一字节
2. 猜测M1最后一字节G
3. 利用XOR运算构造有效填充
4. 通过预言机验证猜测
5. 重复直至解密全部字节

### 实际应用限制

TLS的防御机制:
- 错误时关闭连接
- 重新协商密钥

但在IMAP场景仍可利用:
- 每5分钟重连一次
- 发送相同登录消息
- 可逐字节破解密码

## 防御措施

1. 使用"先加密后MAC":
   - MAC验证在解密前完成
   - 无需进行填充检查

2. 使用计数器模式替代CBC:
   - 无需填充
   - 不受填充预言机攻击影响

## 教训

1. MAC-then-CBC需谨慎:
   - 不能泄露解密失败原因
   - 填充预言机会破坏认证加密性质

2. 优先使用标准方案:
   - 避免自行实现
   - 使用经过验证的构造
